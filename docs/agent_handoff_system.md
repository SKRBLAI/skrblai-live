# Agent Handoff System Documentation

This document explains the architecture and implementation of the cross-agent handoff system in the SKRBL AI platform.

## Overview

The agent handoff system is designed to create seamless, multi-agent workflows that can guide a user through a complex task. The system is composed of two main parts:

1.  **The Agent League (`lib/agents/agentLeague.ts`)**: This is the central configuration file for all agents. It defines their powers, personalities, and, most importantly, their handoff targets.
2.  **The Handoff System (`lib/agents/handoffSystem.ts`)**: This is the engine that powers the handoff logic. It analyzes the context of a user's interaction, recommends potential handoffs, and executes them.

## The Handoff Pattern

A handoff is defined as the process of transferring control from one agent to another. This is not just a simple redirect, but a stateful transfer that includes the context of the user's workflow.

The system supports two types of handoffs:

1.  **Explicit Handoffs**: These are pre-defined handoff paths configured in the `CROSS_AGENT_HANDOFFS` object in `agentLeague.ts`. They are triggered by specific keywords in the user's prompt.
2.  **Intelligent Handoffs**: These are AI-powered recommendations that are generated by the `HandoffSystem`. It analyzes the user's intent and can suggest a handoff to any agent in the league, even if an explicit path is not defined.

## How to Configure a Handoff Chain

To create a new handoff chain, you need to add a new entry to the `CROSS_AGENT_HANDOFFS` object in `lib/agents/agentLeague.ts`.

Here is an example of the `branding-agent` -> `social-bot-agent` handoff:

```typescript
// in lib/agents/agentLeague.ts

const CROSS_AGENT_HANDOFFS: Record<string, CrossAgentHandoff[]> = {
  'branding-agent': [
    {
      targetAgentId: 'social-bot-agent',
      triggerConditions: ['social', 'promote', 'share', 'post'],
      handoffMessage: 'Your new branding is ready! Shall we get SocialBot to create a social media campaign to show it off?',
      autoTrigger: false,
      confidence: 95
    }
  ],
  // ... other handoffs
};
```

*   `targetAgentId`: The ID of the agent to hand off to.
*   `triggerConditions`: An array of keywords that will trigger this handoff recommendation.
*   `handoffMessage`: The message that will be displayed to the user to suggest the handoff.
*   `autoTrigger`: If set to `true`, the handoff will be executed automatically without user confirmation (use with caution).
*   `confidence`: A score from 0-100 that indicates how confident the system is in this recommendation.

## The Handoff Execution Flow

1.  After an agent finishes its execution, the `HandoffSystem.analyzeHandoffOpportunities()` method is called.
2.  This method analyzes the user's prompt and the agent's execution result to find potential handoffs in `agentLeague.ts`.
3.  If a handoff is recommended (and confirmed by the user, if `autoTrigger` is `false`), the `HandoffSystem.executeHandoff()` method is called.
4.  `executeHandoff()` then calls the `runAgentWorkflow()` function for the target agent, passing the context from the source agent.
5.  The entire process, from recommendation to execution, is logged in the `agent_handoffs` table in Supabase.

## Context Passing

The `HandoffContext` object is passed from the source agent to the target agent. This object contains the `executionResult` of the source agent, which can include any data that the target agent might need to continue the workflow.

The `extractContinuationData()` method in `handoffSystem.ts` is responsible for extracting the relevant data from the `executionResult`. You can customize this method to pass specific data points for different handoff scenarios.

## Error Handling

If an agent in a handoff chain fails, the `HandoffExecution` status is set to `failed`, and the error is logged in the `agent_handoffs` table. The system does not currently support automatic retries or fallbacks, but this is a potential area for future improvement. 